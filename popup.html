<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Cyber Guardian</title>
    <style>
        body {
            width: 350px;
            min-height: 200px;
            margin: 0;
            padding: 20px;
            font-family: 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #0f0f23, #1a1a2e);
            color: #00ff41;
        }

        .header {
            text-align: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #00ff41;
        }

        .logo {
            font-size: 24px;
            margin-bottom: 8px;
        }

        h1 {
            font-size: 18px;
            margin: 0;
            color: #00ff41;
        }

        .status {
            background: rgba(0, 255, 65, 0.1);
            border: 1px solid #00ff41;
            border-radius: 8px;
            padding: 15px;
            margin: 15px 0;
            text-align: center;
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            font-size: 14px;
        }

        .stat-label { color: #a0a0a0; }
        .stat-value { color: #00ff41; font-weight: bold; }

        .buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-top: 20px;
        }

        .btn {
            background: linear-gradient(45deg, #00ff41, #39ff14);
            color: #000;
            border: none;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 255, 65, 0.4);
        }

        .btn.secondary {
            background: #333;
            color: #00ff41;
            border: 1px solid #00ff41;
        }

        .info {
            font-size: 12px;
            color: #666;
            text-align: center;
            margin-top: 15px;
            line-height: 1.4;
        }

        code {
            background: rgba(0, 255, 65, 0.1);
            padding: 2px 4px;
            border-radius: 3px;
            color: #00ff41;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">üõ°Ô∏è</div>
        <h1>Cyber Guardian</h1>
    </div>

    <div class="status">
        <div class="stat-item">
            <span class="stat-label">Status:</span>
            <span class="stat-value">üü¢ Active</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Allowed TLDs:</span>
            <span class="stat-value">.com, .org</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Whitelisted:</span>
            <span class="stat-value" id="whitelistCount">Loading...</span>
        </div>
    </div>

    <div class="buttons">
        <button id="openFullSettings" class="btn">‚öôÔ∏è Open Full Settings</button>
        <button id="addDomain" class="btn secondary">‚ûï Quick Add Domain</button>
        <button id="viewBlocked" class="btn secondary">üö´ Test Blocking</button>
    </div>

    <div class="info">
        <strong>Quick Access:</strong> Click the extension icon anytime to manage settings.
        <br><br>
        Blocking all domains except <code>.com</code> and <code>.org</code> plus your whitelist.
    </div>

    <script>
        console.log('üõ°Ô∏è Cyber Guardian Popup loaded');

        // Load whitelist count
        async function loadWhitelistCount() {
            try {
                const { whitelist = [] } = await chrome.storage.sync.get({ whitelist: [] });
                document.getElementById('whitelistCount').textContent = whitelist.length + ' domains';
                console.log('Popup loaded count:', whitelist.length);
            } catch (err) {
                document.getElementById('whitelistCount').textContent = 'Error loading';
            }
        }

        // Refresh count when popup becomes visible
        function refreshCount() {
            loadWhitelistCount();
        }

        // Listen for storage changes
        if (chrome.storage && chrome.storage.onChanged) {
            chrome.storage.onChanged.addListener((changes, namespace) => {
                if (namespace === 'sync' && changes.whitelist) {
                    const newCount = changes.whitelist.newValue ? changes.whitelist.newValue.length : 0;
                    document.getElementById('whitelistCount').textContent = newCount + ' domains';
                    console.log('Count updated via storage listener:', newCount);
                }
            });
        }

        // Open full settings
        document.getElementById('openFullSettings').onclick = function() {
            chrome.runtime.openOptionsPage();
            window.close();
        };

        // Quick add domain
        document.getElementById('addDomain').onclick = function() {
            const domain = prompt('Enter domain to whitelist (e.g., github.io):');
            if (domain && domain.trim()) {
                addDomainToWhitelist(domain.trim().toLowerCase());
            }
        };

        // Test blocking
        document.getElementById('viewBlocked').onclick = function() {
            chrome.tabs.create({ url: 'https://example.net' });
            window.close();
        };

        async function addDomainToWhitelist(domain) {
            try {
                // Remove protocol and trailing slash
                domain = domain.replace(/^https?:\/\//, '').replace(/\/$/, '');
                
                const { whitelist = [] } = await chrome.storage.sync.get({ whitelist: [] });
                
                if (whitelist.includes(domain)) {
                    alert('Domain already in whitelist!');
                    return;
                }
                
                const newWhitelist = [...whitelist, domain];
                await chrome.storage.sync.set({ whitelist: newWhitelist });
                
                alert(`‚úÖ Added "${domain}" to whitelist!`);
                loadWhitelistCount(); // Refresh count
            } catch (err) {
                alert('Error adding domain. Please use the full settings page.');
            }
        }

        // Initialize
        loadWhitelistCount();
        
        // Refresh count when popup is opened
        document.addEventListener('visibilitychange', () => {
            if (!document.hidden) {
                refreshCount();
            }
        });
        
        // Also refresh on window focus
        window.addEventListener('focus', refreshCount);
    </script>
</body>
</html>